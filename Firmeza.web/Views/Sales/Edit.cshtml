@model Firmeza.Application.DTOs.Sales.SaleEditViewModel

@{
    ViewData["Title"] = "Edit Sale";
}

<h2 class="text-dark mb-4 border-bottom border-warning pb-2">✏️ Edit Sale</h2>

<div class="row">
    <div class="col-md-10 col-lg-8">
        <div class="card shadow-lg p-4 bg-dark text-white border-warning border-3">
            <div class="card-body">

                <form asp-action="Edit" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="Id" />

                    <!-- CUSTOMER -->
                    <div class="mb-4">
                        <label class="form-label text-warning">Customer</label>
                        <select asp-for="CustomerId" class="form-select">
                            @foreach (var c in ViewBag.Customers)
                            {
                                <option value="@c.Id"
                                    selected="@(c.Id == Model.CustomerId)">
                                    @c.Name (@c.Document)
                                </option>
                            }
                        </select>
                    </div>

                    <!-- PRODUCTS TABLE -->
                    <h5 class="text-warning mb-3">Products</h5>

                    <table class="table table-dark table-bordered align-middle" id="saleDetailsTable">
                        <thead class="table-warning text-dark">
                            <tr>
                                <th>Product</th>
                                <th style="width:120px;">Qty</th>
                                <th style="width:150px;">Unit Price</th>
                                <th style="width:60px;">Remove</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.SaleDetails.Count; i++)
                            {
                                <tr>
                                    <td>
                                        <select class="form-select product-select"
                                                name="SaleDetails[@i].ProductId">
                                            @foreach (var p in ViewBag.Products)
                                            {
                                                <option value="@p.Id"
                                                        data-price="@p.UnitPrice"
                                                        selected="@(p.Id == Model.SaleDetails[i].ProductId)">
                                                    @p.Name
                                                </option>
                                            }
                                        </select>
                                    </td>

                                    <td>
                                        <input type="number" class="form-control qty-input"
                                               name="SaleDetails[@i].Quantity"
                                               value="@Model.SaleDetails[i].Quantity" min="1" />
                                    </td>

                                    <td>
                                        <input type="number" class="form-control price-input"
                                               name="SaleDetails[@i].AppliedUnitPrice"
                                               value="@Model.SaleDetails[i].AppliedUnitPrice"
                                               step="0.01" />
                                    </td>

                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-danger"
                                                onclick="removeRow(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <button type="button" class="btn btn-outline-warning mb-3" onclick="addRow()">
                        <i class="fas fa-plus"></i> Add Product
                    </button>

                    <!-- TOTALS -->
                    <div class="mb-3">
                        <label asp-for="Subtotal" class="form-label text-warning"></label>
                        <input asp-for="Subtotal" class="form-control" readonly />
                    </div>

                    <div class="mb-3">
                        <label asp-for="Iva" class="form-label text-warning"></label>
                        <input asp-for="Iva" class="form-control" readonly />
                    </div>

                    <div class="mb-4">
                        <label asp-for="Total" class="form-label text-warning"></label>
                        <input asp-for="Total" class="form-control" readonly />
                    </div>

                    <button type="submit" class="btn btn-warning fw-bold">
                        <i class="fas fa-save"></i> Save Changes
                    </button>

                    <a asp-action="Index" class="btn btn-outline-secondary text-white ms-3">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                </form>

            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let products = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        ViewBag.Products,
        new System.Text.Json.JsonSerializerOptions {
            PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
        }));

    /// ADD NEW ROW
    function addRow() {
        const table = document.querySelector("#saleDetailsTable tbody");
        let index = table.rows.length;

        let row = document.createElement("tr");

        row.innerHTML = `
            <td>
                <select class="form-select product-select"
                        name="SaleDetails[${index}].ProductId">
                    <option value="">-- Select Product --</option>
                    ${products.map(p => `
                        <option value="${p.id}" data-price="${p.unitPrice}">
                            ${p.name}
                        </option>`).join("")}
                </select>
            </td>

            <td>
                <input type="number" class="form-control qty-input"
                       name="SaleDetails[${index}].Quantity" min="1" value="1"/>
            </td>

            <td>
                <input type="number" class="form-control price-input"
                       name="SaleDetails[${index}].AppliedUnitPrice"
                       step="0.01" value="0"/>
            </td>

            <td class="text-center">
                <button type="button" class="btn btn-sm btn-danger"
                        onclick="removeRow(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;

        table.appendChild(row);

        attachEvents(row);
    }

    /// REMOVE ROW
    function removeRow(button) {
        button.closest("tr").remove();
        calculateTotals();
    }

    /// ATTACH EVENTS TO NEW ROWS
    function attachEvents(row) {
        row.querySelector(".product-select").addEventListener("change", function () {
            let price = this.selectedOptions[0].dataset.price;
            row.querySelector(".price-input").value = price;
            calculateTotals();
        });

        row.querySelector(".qty-input").addEventListener("input", calculateTotals);
        row.querySelector(".price-input").addEventListener("input", calculateTotals);
    }

    /// INITIAL EVENTS FOR EXISTING ROWS
    document.querySelectorAll("#saleDetailsTable tbody tr").forEach(row => attachEvents(row));

    /// CALCULATE TOTALS
    function calculateTotals() {
        let subtotal = 0;

        document.querySelectorAll("#saleDetailsTable tbody tr").forEach(row => {
            let qty = parseFloat(row.querySelector(".qty-input").value) || 0;
            let price = parseFloat(row.querySelector(".price-input").value) || 0;
            subtotal += qty * price;
        });

        let iva = subtotal * 0.19;
        let total = subtotal + iva;

        document.querySelector("input[name='Subtotal']").value = subtotal.toFixed(2);
        document.querySelector("input[name='Iva']").value = iva.toFixed(2);
        document.querySelector("input[name='Total']").value = total.toFixed(2);
    }

    calculateTotals();
</script>

@{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
